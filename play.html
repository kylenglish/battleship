<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Sea Battle Player</title><script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script><link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Lobster&family=Marck+Script&family=Montserrat:wght@400;700&family=Noto+Sans:wght@400;700&family=Open+Sans:wght@400;700&family=PT+Sans:wght@400;700&family=Rubik:wght@400;700&display=swap" rel="stylesheet"><style>:root{--accent:#00d4ff;--text-color:#ffffff;--blur:0px;--hit-color:#3e8e5e;--miss-color:#a34646;--error-color:#ff4d4d;--cell-size:50px;--base-font-size:16px}body{margin:0;padding:0;background:#0a192f;color:var(--text-color);font-family:var(--font-family,'Segoe UI',sans-serif);height:100vh;width:100vw;overflow:hidden;background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center}.bg-overlay{position:fixed;top:0;left:0;right:0;bottom:0;backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));z-index:-1}body.all-neon{text-shadow:var(--neon-text-intensity)}.neon-text{text-shadow:var(--neon-text-intensity)}#app-container{width:100%;height:100%;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;box-sizing:border-box;padding:10px}.info-panel{width:100%;flex-shrink:0;display:flex;flex-direction:column;justify-content:center;align-items:center;padding-bottom:15px;z-index:10}.game-panel{width:100%;flex-grow:1;display:flex;justify-content:center;align-items:center;overflow:hidden}#startScreen{background:rgba(10,25,47,0.85);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:3px solid var(--accent);border-radius:20px;padding:30px;text-align:center;width:80%;max-width:700px;max-height:90vh;overflow-y:auto;position:absolute;z-index:100;box-shadow:var(--neon-border-intensity);display:flex;flex-direction:column;align-items:center;justify-content:center}#titleDisp{color:var(--accent);font-size:calc(var(--base-font-size) * 3);margin:0 0 15px 0;line-height:1.1}.rules-list{text-align:left;margin:15px 0 25px 0;font-size:calc(var(--base-font-size) * 1.3);line-height:1.5;width:100%}.rules-list div::before{content:"\2666\FE0E ";color:var(--accent)!important;margin-right:5px}#turnInfo{color:var(--accent);margin-bottom:10px;font-weight:bold;font-size:calc(var(--base-font-size) * 2.0);text-align:center;line-height:1.2}#statBar{font-weight:bold;font-size:calc(var(--base-font-size) * 1.5);text-align:center;display:flex;flex-direction:row;flex-wrap:wrap;align-items:center;justify-content:center;gap:15px}.stat-line{display:flex;align-items:center;justify-content:center}.stat-icon{height:1.2em;width:auto;margin-right:8px;vertical-align:middle}.grid-container{display:grid;gap:4px;padding:10px;background:rgba(0,0,0,0.3);border:2px solid var(--accent);border-radius:15px;box-shadow:var(--neon-border-intensity);justify-content:center;max-width:100%;box-sizing:border-box}.cell{width:100%;height:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:0.2s;font-size:clamp(12px,calc(var(--cell-size) * 0.30),24px);text-align:center;overflow:hidden;white-space:normal;word-break:normal;overflow-wrap:break-word;hyphens:auto;line-height:1.1;padding:2px;box-sizing:border-box}.cell:hover{background:var(--accent)!important;color:#000!important;box-shadow:0 0 15px var(--accent);transform:scale(1.05);z-index:2;border-color:var(--accent)}.cell img{width:100%;height:100%;object-fit:contain;display:block}.cell.hit-green{background:var(--hit-color)!important;border-color:#fff}.cell.miss-red{background:var(--miss-color)!important;border-color:#fff}.header-cell{border:none;background:none;font-weight:bold;color:var(--text-color);cursor:default;font-size:clamp(12px,calc(var(--cell-size) * 0.28),24px);display:flex;align-items:center;justify-content:center;text-align:center;white-space:normal;word-break:normal;overflow-wrap:break-word;hyphens:auto;line-height:1.1;padding:1px;box-sizing:border-box}.header-cell img{width:100%;height:100%;border-radius:4px;object-fit:contain}.highlight-header{background-color:var(--accent)!important;color:#000!important;border-radius:5px;box-shadow:0 0 15px var(--accent);text-shadow:none}button{background:var(--accent);color:#0a192f;border:none;padding:15px 40px;font-size:calc(var(--base-font-size) * 1.3);font-weight:bold;border-radius:10px;cursor:pointer;margin-top:15px;transition:0.3s;text-transform:uppercase;width:auto}button:hover{filter:brightness(1.2);transform:translateY(-2px);box-shadow:0 0 15px var(--accent)}.team-input{width:100%;padding:12px;margin:8px 0;background:rgba(0,0,0,0.5);border:1px solid var(--accent);color:white;border-radius:5px;box-sizing:border-box;font-size:calc(var(--base-font-size) * 1.1);-webkit-appearance:none}#modalOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:none;-webkit-backdrop-filter:none;z-index:2000;align-items:center;justify-content:center}.modal-content{background:rgba(10,25,47,0.85);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:3px solid var(--accent);padding:30px;border-radius:20px;text-align:center;width:85%;max-width:500px;box-shadow:0 0 30px rgba(0,0,0,0.5)}#modalTask{color:var(--accent);font-weight:bold;font-size:calc(var(--base-font-size) * 1.8);margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;padding:10px 0;line-height:1.5}#modalTask img{max-height:60px;width:auto;object-fit:contain}#userAnswer{width:100%;padding:15px;margin-bottom:20px;background:rgba(0,0,0,0.5);color:#fff;border:1px solid var(--accent);border-radius:8px;text-align:center;font-size:1.2rem;-webkit-appearance:none;transition:all 0.3s ease}input#userAnswer.shake{border:2px solid var(--error-color)!important;box-shadow:0 0 15px var(--error-color)!important;background:rgba(255,77,77,0.15)!important}#winScreen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:none;-webkit-backdrop-filter:none;align-items:center;justify-content:center;z-index:3000;box-sizing:border-box;padding:10px}#winContent{background:rgba(10,25,47,0.85);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:3px solid var(--accent);padding:20px;border-radius:20px;text-align:center;box-shadow:0 0 40px var(--accent);width:100%;max-width:500px;display:flex;flex-direction:column;align-items:center}#winImgContainer img{max-width:100%;max-height:30vh;height:auto;margin:15px auto;border-radius:10px;box-shadow:0 0 15px var(--accent);display:block;object-fit:contain}#winText{font-size:clamp(1.2rem,5vw,2.5rem);margin:0 0 15px 0;line-height:1.4;word-break:normal}#restartBtn{flex-shrink:0}#progress-area{width:95%;max-width:900px;text-align:center;margin:10px auto 0 auto}.water-tank{width:100%;height:26px;background:rgba(255,255,255,0.05);border:3px solid var(--accent);border-radius:15px;overflow:hidden;margin-top:5px;position:relative;animation:pulseTank 1.5s infinite alternate}@keyframes pulseTank{0%{box-shadow:0 0 5px var(--accent),inset 0 0 5px var(--accent)}100%{box-shadow:0 0 20px var(--accent),inset 0 0 15px var(--accent)}}#water-fill{width:0%;height:100%;background:linear-gradient(90deg,var(--accent),#ffffff,var(--accent));background-size:200% 100%;animation:moveGradient 3s infinite linear;transition:width 0.6s ease;opacity:0.9}@keyframes moveGradient{0%{background-position:0% 0%}100%{background-position:100% 0%}}.shake{animation:shake 0.4s cubic-bezier(.36,.07,.19,.97) both}@keyframes shake{10%,90%{transform:translate3d(-1px,0,0)}20%,80%{transform:translate3d(2px,0,0)}30%,50%,70%{transform:translate3d(-4px,0,0)}40%,60%{transform:translate3d(4px,0,0)}}#combo-meter{position:fixed;top:10px;right:10px;background:rgba(0,0,0,0.85);padding:5px 15px;border-radius:50px;border:2px solid #f1c40f;color:#f1c40f;font-weight:bold;display:none;z-index:100;font-size:1rem;box-shadow:0 0 10px #f1c40f}.combo-active{display:block!important;animation:pulse 0.8s infinite alternate}@keyframes pulse{from{transform:scale(1);}to{transform:scale(1.15);}}</style></head><body><script>const audioCtx=new(window.AudioContext||window.webkitAudioContext)();function playSound(e,t,o,n=0.1){if(audioCtx.state==='suspended')audioCtx.resume();const i=audioCtx.currentTime;e.forEach((e,a)=>{const s=audioCtx.createOscillator();const c=audioCtx.createGain();s.type=t;s.frequency.setValueAtTime(e,i+(a*0.08));s.connect(c);c.connect(audioCtx.destination);c.gain.setValueAtTime(n,i+(a*0.08));c.gain.exponentialRampToValueAtTime(0.01,i+(a*0.08)+o);s.start(i+(a*0.08));s.stop(i+(a*0.08)+o)})}function playSadSound(){playSound([300,250,200,150],'sawtooth',0.6,0.2)}</script><div class="bg-overlay"></div><div id="combo-meter">üî• COMBO X<span id="combo-count">0</span></div><div id="modalOverlay"><div class="modal-content" id="modalBox"><h3 id="modalTitle" style="margin-top:0; color:#fff;">–°–æ—Å—Ç–∞–≤—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h3><div id="modalTask"></div><input type="text" id="userAnswer" placeholder="..." autocomplete="off"><button onclick="checkModalAnswer()" id="shotBtn">–í–´–°–¢–†–ï–õ–ò–¢–¨!</button></div></div><div id="startScreen"><h1 id="titleDisp" class="neon-text">–ú–û–†–°–ö–û–ô –ë–û–ô</h1><div class="rules-list" id="rulesBlock"></div><div id="teamSetup" style="display:none; margin-top: 10px; width: 100%;"></div><button id="startBtn" onclick="handleStartClick()">–ò–ì–†–ê–¢–¨</button></div><div id="winScreen"><div id="winContent"><h2 id="winText" class="neon-text"></h2><div id="winImgContainer"></div><button onclick="location.reload()" id="restartBtn">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button></div></div><div id="app-container" style="visibility: hidden;"><div class="info-panel"><div id="turnInfo"></div><div id="statBar"></div> <div id="progress-area"><div class="water-tank"><div id="water-fill"></div></div></div></div><div class="game-panel"><div id="grid" class="grid-container"></div></div></div><script>const urlParams=new URLSearchParams(window.location.search);let cfg={t:"–ú–û–†–°–ö–û–ô –ë–û–ô",x:[],y:[],c:"#00d4ff",s:3,fColor:"#ffffff",bg:"",blur:0,winT:"–ü–æ–±–µ–¥–∞!",winI:"",mode:"classic",answers:"",challengeLimit:30,challengeType:"time",gameType:"solo",teamCount:2,lang:"ru",font:"PT Sans",neonText:true,neonBorder:true,rules:"–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–ª–µ—Ç–∫–∏...",bgColor:"#0a192f",resetBg:false};if(urlParams.has('data')){try{let rawData=urlParams.get('data').replace(/ /g,'+');let decoded=JSON.parse(decodeURIComponent(escape(atob(rawData))));cfg={...cfg,...decoded}}catch(e){console.error("–û—à–∏–±–∫–∞",e)}}const translations={ru:{found:"–ù–∞–π–¥–µ–Ω–æ",you:"–í—ã",robot:"–†–æ–±–æ—Ç",turn:"–•–û–î",yourTurn:"–í–ê–® –•–û–î",robotTurn:"–•–û–î –†–û–ë–û–¢–ê...",timeUp:"–í–†–ï–ú–Ø –í–´–®–õ–û!",noMoves:"–•–û–î–´ –ó–ê–ö–û–ù–ß–ò–õ–ò–°–¨",gameOver:"–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê",play:"–ò–ì–†–ê–¢–¨",playAgain:"–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê",fire:"–í–´–°–¢–†–ï–õ–ò–¢–¨!",makeSentence:"–°–æ—Å—Ç–∞–≤—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ",writeHere:"–ù–∞–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å...",team:"–ö–æ–º–∞–Ω–¥–∞",winner:"–ü–æ–±–µ–¥–∏—Ç–µ–ª—å",score:"–°—á–µ—Ç"},en:{found:"Found",you:"You",robot:"Robot",turn:"TURN",yourTurn:"YOUR TURN",robotTurn:"ROBOT'S TURN...",timeUp:"TIME'S UP!",noMoves:"OUT OF MOVES",gameOver:"GAME OVER",play:"PLAY",playAgain:"PLAY AGAIN",fire:"FIRE!",makeSentence:"Make a sentence",writeHere:"Write here...",team:"Team",winner:"Winner",score:"Score"},fr:{found:"Trouv√©",you:"Vous",robot:"Robot",turn:"TOUR",yourTurn:"√Ä VOUS",robotTurn:"TOUR DU ROBOT...",timeUp:"TEMPS √âCOUL√â!",noMoves:"PLUS DE COUPS",gameOver:"JEU TERMIN√â",play:"JOUER",playAgain:"REJOUER",fire:"TIRER!",makeSentence:"Faites une phrase",writeHere:"√âcrivez ici...",team:"√âquipe",winner:"Gagnant",score:"Score"},es:{found:"Encontrado",you:"T√∫",robot:"Robot",turn:"TURNO",yourTurn:"TU TURNO",robotTurn:"TURNO DEL ROBOT...",timeUp:"¬°TIEMPO AGOTADO!",noMoves:"SIN MOVIMIENTOS",gameOver:"JUEGO TERMINADO",play:"JUGAR",playAgain:"JUGAR OTRA VEZ",fire:"¬°DISPARAR!",makeSentence:"Haz una frase",writeHere:"Escribe aqu√≠...",team:"Equipo",winner:"Ganador",score:"Puntuaci√≥n"},de:{found:"Gefunden",you:"Du",robot:"Roboter",turn:"ZUG",yourTurn:"DEIN ZUG",robotTurn:"ROBOTER ZUG...",timeUp:"ZEIT ABGELAUFEN!",noMoves:"KEINE Z√úGE MEHR",gameOver:"SPIEL VORBEI",play:"SPIELEN",playAgain:"NOCHMAL SPIELEN",fire:"FEUERN!",makeSentence:"Bilde einen Satz",writeHere:"Hier schreiben...",team:"Team",winner:"Gewinner",score:"Ergebnis"},zh:{found:"ÊâæÂà∞",you:"‰Ω†",robot:"Êú∫Âô®‰∫∫",turn:"ÂõûÂêà",yourTurn:"‰Ω†ÁöÑÂõûÂêà",robotTurn:"Êú∫Âô®‰∫∫ÂõûÂêà...",timeUp:"Êó∂Èó¥Âà∞!",noMoves:"Ê≠•Êï∞Áî®Â∞Ω",gameOver:"Ê∏∏ÊàèÁªìÊùü",play:"ÂºÄÂßãÊ∏∏Êàè",playAgain:"ÂÜçÁé©‰∏ÄÊ¨°",fire:"ÂèëÂ∞Ñ!",makeSentence:"ÈÄ†Âè•",writeHere:"Âú®Ê≠§ËæìÂÖ•...",team:"Èòü‰ºç",winner:"Ëé∑ËÉúËÄÖ",score:"ÂàÜÊï∞"},ja:{found:"Áô∫Ë¶ã",you:"„ÅÇ„Å™„Åü",robot:"„É≠„Éú„ÉÉ„Éà",turn:"„Çø„Éº„É≥",yourTurn:"„ÅÇ„Å™„Åü„ÅÆÁï™",robotTurn:"„É≠„Éú„ÉÉ„Éà„ÅÆÁï™...",timeUp:"ÊôÇÈñìÂàá„Çå!",noMoves:"ÊâãÊï∞Âàá„Çå",gameOver:"„Ç≤„Éº„É†ÁµÇ‰∫Ü",play:"„Éó„É¨„Ç§",playAgain:"„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§",fire:"Áô∫Â∞Ñ!",makeSentence:"Êñá„Çí‰Ωú„Å£„Å¶„Åè„Å†„Åï„ÅÑ",writeHere:"„Åì„Åì„Å´ÂÖ•Âäõ...",team:"„ÉÅ„Éº„É†",winner:"ÂãùËÄÖ",score:"„Çπ„Ç≥„Ç¢"},math:{found:"–ù–∞–π–¥–µ–Ω–æ",you:"–í—ã",robot:"–†–æ–±–æ—Ç",turn:"–•–û–î",yourTurn:"–í–ê–® –•–û–î",robotTurn:"–•–û–î –†–û–ë–û–¢–ê...",timeUp:"–í–†–ï–ú–Ø –í–´–®–õ–û!",noMoves:"–•–û–î–´ –ó–ê–ö–û–ù–ß–ò–õ–ò–°–¨",gameOver:"–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê",play:"–ò–ì–†–ê–¢–¨",playAgain:"–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê",fire:"–†–ï–®–ò–¢–¨!",makeSentence:"–í—ã—á–∏—Å–ª–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ",writeHere:"–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç (—á–∏—Å–ª–æ)...",team:"–ö–æ–º–∞–Ω–¥–∞",winner:"–ü–æ–±–µ–¥–∏—Ç–µ–ª—å",score:"–°—á–µ—Ç"}};const txt=translations[cfg.lang]||translations.ru;document.getElementById('startBtn').innerText=txt.play;document.getElementById('restartBtn').innerText=txt.playAgain;document.getElementById('shotBtn').innerText=txt.fire;document.getElementById('modalTitle').innerText=txt.makeSentence;document.getElementById('userAnswer').placeholder=txt.writeHere;document.getElementById('titleDisp').innerText=cfg.t;document.getElementById('rulesBlock').innerHTML=cfg.rules.split('\n').map(r=>`<div>${r}</div>`).join('');const root=document.documentElement;root.style.setProperty('--accent',cfg.c);root.style.setProperty('--text-color',cfg.fColor);root.style.setProperty('--blur',(cfg.blur||0)+"px");if(cfg.font)root.style.setProperty('--font-family',`'${cfg.font}', sans-serif`);if(cfg.transparentBg){document.documentElement.style.background="transparent";document.body.style.background="transparent";document.body.style.backgroundImage="none";const glassStyle=document.createElement('style');glassStyle.innerHTML=`html, body, :root { background: transparent !important; background-color: transparent !important; } .bg-overlay { display: none !important; } #startScreen, #winContent, .modal-content { background: rgba(10, 25, 47, 0.4) !important; backdrop-filter: blur(15px) saturate(150%) !important; -webkit-backdrop-filter: blur(15px) saturate(150%) !important; border: 2px solid rgba(255, 255, 255, 0.2) !important; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3) !important; } .team-input, #combo-meter, #userAnswer { background: rgba(255, 255, 255, 0.1) !important; backdrop-filter: blur(10px) !important; -webkit-backdrop-filter: blur(10px) !important; border: 1px solid rgba(255, 255, 255, 0.3) !important; color: #fff !important; } input#userAnswer.shake { border: 2px solid var(--error-color) !important; box-shadow: 0 0 15px var(--error-color) !important; background: rgba(255, 77, 77, 0.15) !important; } #winScreen, #modalOverlay { background: rgba(0, 0, 0, 0.5) !important; backdrop-filter: none !important; -webkit-backdrop-filter: none !important; } #winText, #modalTitle, #modalTask, .rules-list div, #userAnswer { color: #ffffff !important; text-shadow: 0 0 10px rgba(0,0,0,0.5) !important; } .grid-container { background: rgba(0, 0, 0, 0.2) !important; backdrop-filter: blur(5px) !important; -webkit-backdrop-filter: blur(5px) !important; border: 2px solid var(--accent) !important; }`;document.head.appendChild(glassStyle)}else if(cfg.resetBg){document.body.style.background="#0a192f";document.body.style.backgroundImage="none"}else{if(cfg.bgColor&&cfg.bgColor!=="#0a192f")document.body.style.background=cfg.bgColor;if(cfg.bg){if(cfg.bg.startsWith('http'))document.body.style.backgroundImage=`url('${cfg.bg}')`;else document.body.style.background=cfg.bg}}root.style.setProperty('--neon-text-intensity',(cfg.neonText!==false&&cfg.neonText!=="false")?`0 0 10px ${cfg.fColor}`:'none');root.style.setProperty('--neon-border-intensity',(cfg.neonBorder!==false&&cfg.neonBorder!=="false")?`0 0 20px ${cfg.c}66`:'none');if(cfg.neonText!==false&&cfg.neonText!=="false")document.body.classList.add('all-neon');let found=0,pcFound=0,gameOver=false,timerInterval;let isPlayerTurn=true,currentTeamIdx=0,teams=[];let timeLeft=parseInt(cfg.challengeLimit)||30;let movesLeft=parseInt(cfg.challengeLimit)||30;let hitCombo=0;const targets=new Set(),openedCells=new Set();const ansMap=cfg.answers?cfg.answers.split('\n').map(a=>a.trim().toLowerCase()):[];let currentAttemptIdx=null,currentAttemptCell=null,cellElements={};let lastGridW=0,lastGridH=0;function resizeGame(){const container=document.getElementById('app-container');const infoPanel=document.querySelector('.info-panel');const gamePanel=document.querySelector('.game-panel');const grid=document.getElementById('grid');const totalH=container.clientHeight;const infoH=infoPanel.offsetHeight;const availableH=totalH-infoH-20;const w=gamePanel.clientWidth;const cols=cfg.x.length+1;const rows=cfg.y.length+1;const maxCellW=Math.floor((w-24-(cols-1)*4)/cols);const maxCellH=Math.floor((availableH-24-(rows-1)*4)/rows);let cellSize=Math.min(maxCellW,maxCellH);cellSize=Math.max(15,Math.min(cellSize,110));root.style.setProperty('--cell-size',cellSize+'px');if(grid){grid.style.gridTemplateColumns=`repeat(${cols}, minmax(0, var(--cell-size)))`;grid.style.gridTemplateRows=`repeat(${rows}, minmax(0, var(--cell-size)))`}const minDim=Math.min(window.innerWidth,window.innerHeight);root.style.setProperty('--base-font-size',Math.max(16,(minDim/35))+'px');if(grid&&document.getElementById('progress-area')){document.getElementById('progress-area').style.width=grid.offsetWidth+'px';document.getElementById('progress-area').style.maxWidth='none'}const gridW=grid?grid.offsetWidth:0;const gridH=grid?grid.offsetHeight:0;if(lastGridW!==gridW||lastGridH!==gridH){lastGridW=gridW;lastGridH=gridH;setTimeout(()=>{document.querySelectorAll('.cell').forEach(el=>{if(el.querySelector('img'))return;el.style.fontSize='';let currentSize=parseFloat(window.getComputedStyle(el).fontSize);while((el.scrollHeight>el.clientHeight||el.scrollWidth>el.clientWidth)&&currentSize>12){currentSize-=0.5;el.style.fontSize=currentSize+'px'}})},50)}}window.addEventListener('resize',resizeGame);setInterval(resizeGame,1000);function renderHeaderContent(val){if(val.toLowerCase().startsWith('http'))return `<img src="${val.trim()}">`;if(cfg.lang==='math'){try{return katex.renderToString(val,{throwOnError:false,displayMode:false})}catch(e){return val}}return val}function handleStartClick(){playSound([440,554,659,880],'sine',0.6);if(cfg.gameType==='team'&&teams.length===0){document.getElementById('rulesBlock').style.display='none';document.getElementById('startBtn').style.display='none';showTeamSetup()}else{startGame()}}function showTeamSetup(){const setup=document.getElementById('teamSetup');setup.style.display='block';setup.innerHTML=`<h3 style="color:var(--accent); margin:0 0 10px 0;">${txt.team}:</h3>`;for(let i=1;i<=cfg.teamCount;i++){setup.innerHTML+=`<input type="text" id="teamName${i}" class="team-input" placeholder="${txt.team} ${i}">`}const goBtn=document.createElement('button');goBtn.innerText="OK";goBtn.id="startBtn";goBtn.onclick=()=>{playSound([440,554,659,880],'sine',0.6);for(let i=1;i<=cfg.teamCount;i++){let name=document.getElementById(`teamName${i}`).value||`${txt.team} ${i}`;teams.push({name:name,score:0})}startGame()};setup.appendChild(goBtn)}function startGame(){document.getElementById('startScreen').style.display='none';document.getElementById('app-container').style.visibility='visible';initGrid();setTimeout(resizeGame,50);if(cfg.mode==='challenge'&&cfg.challengeType==='time'){timerInterval=setInterval(()=>{timeLeft--;updateStats();if(timeLeft<=0){playSadSound();endGame(false,txt.timeUp)}},1000)}updateStats()}function updateStats(){let statText="";let targetIcon=cfg.targetImg?`<img src="${cfg.targetImg}" class="stat-icon">`:'üö¢';let totalScore=(cfg.gameType==='team')?teams.reduce((a,b)=>a+b.score,0):(found+pcFound);if(cfg.gameType==='team'){let teamScores=teams.map(t=>`${t.name}: ${t.score}`).join(" | ");let commonProgress=`<div class="stat-line">${targetIcon} ${txt.found}: ${totalScore} / ${cfg.s}</div>`;statText=`<div>${teamScores}</div>${commonProgress}`;if(teams.length>0)document.getElementById('turnInfo').innerText=`${txt.turn}: ${teams[currentTeamIdx].name}`}else{if(cfg.mode==='computer'){statText=`<div class="stat-line">${targetIcon} ${txt.you}: ${found} | ${txt.robot}: ${pcFound} / ${cfg.s}</div>`}else{statText=`<div class="stat-line">${targetIcon} ${txt.found}: ${found} / ${cfg.s}</div>`}document.getElementById('turnInfo').innerText=isPlayerTurn?txt.yourTurn:txt.robotTurn}if(cfg.mode==='challenge'){statText+=cfg.challengeType==='time'?` <div class="stat-line">| ‚è± ${timeLeft}s</div>`:` <div class="stat-line">| üéØ ${movesLeft}</div>`}document.getElementById('statBar').innerHTML=statText;let percentage=(totalScore/cfg.s)*100;let fill=document.getElementById('water-fill');if(fill)fill.style.width=Math.min(percentage,100)+'%'}function highlightHeaders(r,c,isActive){const hX=document.getElementById(`header-x-${c}`);const hY=document.getElementById(`header-y-${r}`);if(hX)isActive?hX.classList.add('highlight-header'):hX.classList.remove('highlight-header');if(hY)isActive?hY.classList.add('highlight-header'):hY.classList.remove('highlight-header')}function initGrid(){const grid=document.getElementById('grid');grid.innerHTML='';grid.style.gridTemplateColumns=`repeat(${cfg.x.length+1}, minmax(0, var(--cell-size)))`;const total=cfg.x.length*cfg.y.length;targets.clear();while(targets.size<Math.min(cfg.s,total))targets.add(Math.floor(Math.random()*total));for(let r=0;r<=cfg.y.length;r++){for(let c=0;c<=cfg.x.length;c++){const cell=document.createElement('div');cell.className='cell';if(r===0||c===0){cell.className+=' header-cell';if(r===0&&c===0){}else if(r===0){cell.innerHTML=renderHeaderContent(cfg.x[c-1]);cell.id=`header-x-${c}`}else if(c===0){cell.innerHTML=renderHeaderContent(cfg.y[r-1]);cell.id=`header-y-${r}`}}else{const idx=(r-1)*cfg.x.length+(c-1);cellElements[idx]=cell;cell.onmouseenter=()=>highlightHeaders(r,c,true);cell.onmouseleave=()=>highlightHeaders(r,c,false);cell.onclick=()=>handleMove(idx,cell,cfg.x[c-1],cfg.y[r-1])}grid.appendChild(cell)}}}function handleMove(idx,cell,valX,valY){if(gameOver||openedCells.has(idx)||(!isPlayerTurn&&cfg.mode==='computer'))return;if(cfg.mode==='writing'){currentAttemptIdx=idx;currentAttemptCell=cell;document.getElementById('modalOverlay').style.display='flex';let promptHtml;if(cfg.lang==='math'){promptHtml=`${renderHeaderContent(valX)} &nbsp;&nbsp;&nbsp; ${renderHeaderContent(valY)}`}else{promptHtml=`${renderHeaderContent(valX)} + ${renderHeaderContent(valY)}`}document.getElementById('modalTask').innerHTML=promptHtml;document.getElementById('userAnswer').value='';document.getElementById('userAnswer').focus()}else{const isHit=processCell(idx,cell);if(!isHit&&!gameOver)finalizeTurn()}}function checkModalAnswer(){let userAns=document.getElementById('userAnswer').value.trim().toLowerCase();let correctAns=(ansMap[currentAttemptIdx]||"").toLowerCase();const inputField=document.getElementById('userAnswer');let isCorrect=false;if(cfg.lang==='math'){let cleanUser=userAns.replace(',','.');let cleanCorrect=correctAns.replace(',','.');isCorrect=(parseFloat(cleanUser)===parseFloat(cleanCorrect))&&!isNaN(parseFloat(cleanUser))}else{isCorrect=(userAns&&userAns===correctAns)}if(isCorrect){document.getElementById('modalOverlay').style.display='none';inputField.classList.remove('shake');const isHit=processCell(currentAttemptIdx,currentAttemptCell);if(!isHit&&!gameOver)finalizeTurn()}else{playSound([150,100],'sawtooth',0.4,0.08);inputField.classList.remove('shake');void inputField.offsetWidth;inputField.classList.add('shake')}}function updateComboUI(){const meter=document.getElementById('combo-meter');const countSpan=document.getElementById('combo-count');countSpan.innerText=hitCombo;if(hitCombo>=2){meter.classList.add('combo-active');playSound([600,800,1000],'sine',0.3)}else{meter.classList.remove('combo-active')}}function processCell(idx,cell){if(openedCells.has(idx))return false;if(cfg.mode==='challenge'&&cfg.challengeType==='moves')movesLeft--;openedCells.add(idx);let result=false;if(targets.has(idx)){hitCombo++;playSound([600,800,1000],'sine',0.3);cell.innerHTML=cfg.targetImg?`<img src="${cfg.targetImg}">`:"üö¢";cell.classList.add('hit-green');if(cfg.gameType==='team')teams[currentTeamIdx].score++;else if(isPlayerTurn)found++;else pcFound++;updateStats();updateComboUI();result=true}else{hitCombo=0;updateComboUI();playSound([120,80],'sawtooth',0.4,0.15);cell.innerHTML="";cell.classList.add('miss-red');result=false}const totalOpened=cfg.gameType==='team'?teams.reduce((a,b)=>a+b.score,0):(found+pcFound);if(totalOpened>=cfg.s){setTimeout(()=>checkWinner(),500)}else if(cfg.mode==='challenge'&&cfg.challengeType==='moves'&&movesLeft<=0){playSadSound();endGame(false,txt.noMoves)}return result}function finalizeTurn(){if(gameOver)return;if(cfg.gameType==='team'){currentTeamIdx=(currentTeamIdx+1)%teams.length;updateStats()}else if(cfg.mode==='computer'){isPlayerTurn=false;updateStats();setTimeout(computerTurn,1000)}}function computerTurn(){if(gameOver)return;let avail=[];for(let i=0;i<cfg.x.length*cfg.y.length;i++)if(!openedCells.has(i))avail.push(i);if(avail.length===0)return;let shot=avail[Math.floor(Math.random()*avail.length)];const isHit=processCell(shot,cellElements[shot]);if(isHit&&!gameOver)setTimeout(computerTurn,1000);else{isPlayerTurn=true;updateStats()}}function checkWinner(){let customWinText=cfg.winT||"–ü–æ–±–µ–¥–∞!";if(cfg.gameType==='team'){let winner=teams.reduce((prev,curr)=>(prev.score>curr.score)?prev:curr);let scoreStr=teams.map(t=>t.score).join(" : ");let safeName=winner.name.replace(/ /g,'&nbsp;');endGame(true,`<div style="margin-bottom: 15px;">${customWinText}</div><div style="margin-bottom: 10px;">${txt.winner} - ${safeName}</div><div>${txt.score}: ${scoreStr}</div>`)}else if(cfg.mode==='computer'){let w=(found>=pcFound)?txt.you:txt.robot;let safeW=w.replace(/ /g,'&nbsp;');endGame(found>=pcFound,`<div style="margin-bottom: 15px;">${customWinText}</div><div style="margin-bottom: 10px;">${txt.winner} - ${safeW}</div><div>${txt.score}: ${found} : ${pcFound}</div>`)}else{endGame(found>=pcFound)}}function endGame(isWin,msg){gameOver=true;if(timerInterval)clearInterval(timerInterval);const winText=document.getElementById('winText');const imgContainer=document.getElementById('winImgContainer');if(isWin){winText.innerHTML=(typeof msg==='string'&&msg.length>5)?msg:(cfg.winT||"–ü–æ–±–µ–¥–∞!");if(cfg.winI)imgContainer.innerHTML=`<img src="${cfg.winI}">`;confetti({particleCount:250,spread:100,origin:{y:0.6},colors:['#00d4ff','#ffffff','#27ae60'],zIndex:12000});playSound([400,500,600,800,1000,1200],'triangle',1.0)}else{winText.innerHTML=msg||txt.gameOver;imgContainer.innerHTML=''}document.getElementById('winScreen').style.display='flex'}document.getElementById('userAnswer').addEventListener('keypress',(e)=>{if(e.key==='Enter')checkModalAnswer()});let forceView=urlParams.get('view')||'start';if(forceView==='team'&&cfg.gameType!=='team')forceView='start';if(forceView==='board'){document.getElementById('startScreen').style.display='none';document.getElementById('app-container').style.visibility='visible';if(cfg.gameType==='team'&&teams.length===0){for(let i=1;i<=cfg.teamCount;i++)teams.push({name:txt.team+" "+i,score:0})}initGrid();setTimeout(resizeGame,50);updateStats()}else if(forceView==='team'){document.getElementById('rulesBlock').style.display='none';document.getElementById('startBtn').style.display='none';showTeamSetup()}</script></body></html>
